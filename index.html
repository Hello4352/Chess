<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>사람 vs AI 체스</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      grid-template-rows: repeat(8, 60px);
      border: 2px solid #333;
    }
    .cell {
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 34px;
      cursor: pointer;
    }
    .white { background: #f9f9f9; }
    .black { background: #444; color: white; }
    .selected { outline: 3px solid yellow; }
    #log {
      width: 480px;
      max-height: 150px;
      overflow-y: auto;
      background: white;
      margin-top: 20px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
    }
    button {
      margin-bottom: 15px;
      padding: 8px 16px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>사람 vs AI 체스</h1>
  <button onclick="startGame()">게임 시작</button>
  <div id="board"></div>
  <div id="log"></div>

  <script src="https://cdn.jsdelivr.net/npm/stockfish@15.1.0/stockfish.js"></script>
  <script>
    const PIECES = {
      r: "♜", n: "♞", b: "♝", q: "♛", k: "♚", p: "♟",
      R: "♖", N: "♘", B: "♗", Q: "♕", K: "♔", P: "♙"
    };

    let board = [], selected = null, whiteTurn = true;
    let castlingRights = { K: true, Q: true, k: true, q: true };
    let enPassant = null, logDiv = null;
    let engine = null, gameOver = false;

    function startGame() {
      board = [
        ['r','n','b','q','k','b','n','r'],
        ['p','p','p','p','p','p','p','p'],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['P','P','P','P','P','P','P','P'],
        ['R','N','B','Q','K','B','N','R']
      ];
      castlingRights = { K: true, Q: true, k: true, q: true };
      enPassant = null;
      whiteTurn = true;
      selected = null;
      gameOver = false;
      logDiv = document.getElementById("log");
      logDiv.innerHTML = "<b>게임 로그</b><br>";
      render();
      if (!engine) {
        engine = STOCKFISH();
        engine.onmessage = (msg) => {
          if (msg.startsWith("bestmove")) {
            const move = msg.split(" ")[1];
            if (move && move.length>=4) {
              const fx=move.charCodeAt(0)-97, fy=8-parseInt(move[1]);
              const tx=move.charCodeAt(2)-97, ty=8-parseInt(move[3]);
              movePiece(fx,fy,tx,ty);
              whiteTurn = true;
              render();
              afterMove();
            }
          }
        };
      }
    }

    function render() {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";
      for (let y=0; y<8; y++) {
        for (let x=0; x<8; x++) {
          const cell = document.createElement("div");
          cell.className = "cell " + ((x+y)%2===0?"white":"black");
          const piece = board[y][x];
          cell.textContent = PIECES[piece] || '';
          if (isBlack(piece)) cell.style.color = "black"; 
          else cell.style.color = "";
          cell.dataset.x = x; cell.dataset.y = y;
          if (selected && selected.x===x && selected.y===y) cell.classList.add("selected");
          cell.onclick = () => onClick(x,y);
          boardDiv.appendChild(cell);
        }
      }
    }

    function onClick(x, y) {
      if (gameOver) return;
      const piece = board[y][x];
      if (selected) {
        const sx = selected.x, sy = selected.y;
        const legal = getValidMoves(sx, sy).some(m => m.x===x && m.y===y);
        if (legal) {
          move(sx, sy, x, y);
          whiteTurn = false;
          selected = null;
          render();
          afterMove();
          return;
        }
        selected = null;
      } else if (whiteTurn && isWhite(piece)) {
        selected = {x,y};
      }
      render();
    }

    function move(sx, sy, dx, dy) {
      const piece = board[sy][sx];
      board[dy][dx] = piece;
      board[sy][sx] = '';
      log(`${piece} ${String.fromCharCode(97+sx)}${8-sy} → ${String.fromCharCode(97+dx)}${8-dy}`);
    }

    function movePiece(fx,fy,tx,ty) {
      selected = null;
      move(fx,fy,tx,ty);
    }

    function isWhite(p) { return p && p===p.toUpperCase(); }
    function isBlack(p) { return p && p===p.toLowerCase(); }

    function log(text) {
      logDiv.innerHTML += `<div>${text}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function getAllLegalMoves(colorWhite) {
      const moves = [];
      for (let y=0; y<8; y++) {
        for (let x=0; x<8; x++) {
          const p=board[y][x];
          if (p && (colorWhite?isWhite(p):isBlack(p))) {
            getValidMoves(x,y).forEach(m=>moves.push({from:{x,y},to:m}));
          }
        }
      }
      return moves;
    }

    function inCheck(colorWhite) {
      let kx, ky;
      const color = colorWhite?"K":"k";
      for (let y=0;y<8;y++)for(let x=0;x<8;x++) if (board[y][x]===color){kx=x;ky=y;}
      const opponentMoves = getAllLegalMoves(!colorWhite);
      return opponentMoves.some(m=>m.to.x===kx && m.to.y===ky);
    }

    function afterMove() {
      if (!whiteTurn) {
        if (getAllLegalMoves(false).length===0) {
          if (inCheck(false)) log("체크메이트! 당신 승리"); else log("스테일메이트!");
          gameOver = true; return;
        }
        if (inCheck(false)) log("AI가 체크당함!");
        aiMove();
      } else {
        if (getAllLegalMoves(true).length===0) {
          if (inCheck(true)) log("체크메이트! AI 승리"); else log("스테일메이트!");
          gameOver = true; return;
        }
        if (inCheck(true)) log("체크!");
      }
    }

    function aiMove() {
      const fen = boardToFEN();
      engine.postMessage("position fen "+fen);
      engine.postMessage("go depth 12");
    }

    function boardToFEN() {
      let fen="";
      for (let y=0;y<8;y++){
        let empty=0;
        for (let x=0;x<8;x++){
          const p=board[y][x];
          if (!p) empty++;
          else { if (empty){fen+=empty; empty=0;} fen+=p; }
        }
        if (empty) fen+=empty;
        if (y<7) fen+="/";
      }
      fen += whiteTurn?" w":" b";
      fen += castlingRights.K?" K":""; fen += castlingRights.Q?" Q":"";
      fen += castlingRights.k?" k":""; fen += castlingRights.q?" q":"";
      fen += enPassant?` ${String.fromCharCode(97+enPassant.x)}${8-enPassant.y}`:" -";
      fen += " 0 1";
      return fen;
    }

    window.onload = startGame;
  </script>
</body>
</html>
